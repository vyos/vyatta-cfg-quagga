tag:
type: ipv4
help: Next-hop router
end:
  if [[ -z "$VAR(./disable)" ]]
  then
    ### remove the old entry from frr first on an update
    if [ ${COMMIT_ACTION} = 'ACTIVE' ]
      then
        OLD_IF=`cli-shell-api returnEffectiveValue protocols static route $VAR(../@) next-hop $VAR(@) next-hop-interface`
        vtysh -c "configure terminal" \
              -c "no ip route $VAR(../@) $VAR(@) $OLD_IF $VAR(./distance/@)";
    fi
    if [[ ${COMMIT_ACTION} = 'DELETE' ]]
    then
      if ! ${vyatta_sbindir}/vyatta-next-hop-check $VAR(../@) ipv4 address; then
        exit 1;
      fi
      DIST=`cli-shell-api returnEffectiveValue protocols static route $VAR(../@) next-hop $VAR(@) distance`
      if ${vyatta_sbindir}/vyatta-gateway-static_route-check.pl \
          "$VAR(../@)" "$VAR(@)"
      then
        vtysh -c "configure terminal" \
                     -c "no ip route $VAR(../@) $VAR(@) $DIST" \
                     -c "no ip route $VAR(../@) $VAR(@)"
      fi
    else
      if [ -n "$VAR(./next-hop-vrf/@)" ]; then 
          NEXTHOP_VRF="nexthop-vrf $VAR(./next-hop-vrf/@)"
      fi

      # T3516
      # FRR 7.5.1 use routes as multinode, VyOS as single-node
      # ip route 203.0.113.0/24 10.0.0.1
      # ip route 203.0.113.0/24 10.0.0.1 10
      # ip route 203.0.113.0/24 10.0.0.1 254
      # So we need remove old frr routes before adding new.
      # $VAR(../@) = 203.0.113.0/24
      # $VAR(@) = 10.0.0.1

      data=`vtysh -c "show run staticd no-header" | grep -P "^ip route $VAR(../@) $VAR(@)( \d+){0,1}$"`
      IFS=$'\n' read -d '' -a old_routes <<< ${data}
      for ROUTE in "${old_routes[@]}"
        do
          vtysh -c "conf t" -c "no $ROUTE"
        done

      vtysh -c "configure terminal" \
                   -c "ip route $VAR(../@) $VAR(@) $VAR(./next-hop-interface/@) $NEXTHOP_VRF $VAR(./distance/@)";
    fi
  else
    if ${vyatta_sbindir}/vyatta-gateway-static_route-check.pl \
        "$VAR(../@)" "$VAR(@)"
    then
      vtysh -c "configure terminal" \
                   -c "no ip route $VAR(../@) $VAR(@)"
    fi
  fi
  if [[ "$VAR(../@)" = "0.0.0.0/0" ]]
  then
    ${vyatta_sbindir}/vyatta-gateway-static_route-check.pl warn
  fi
